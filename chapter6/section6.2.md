# 组件模块设计


## 表现面

####文件组织方式清晰明了

给别人的SDK，解压下来后第一眼就能够分辨出每个文件夹是什么作用。资源文件，文档，demo，库，应该很容易进行区分。特别是资源文件，能统一用bundle进行管理的，就不要出现bundle里面有，外面也有这种情况。

####类名前缀和包命名或者缩写要一致

接了一些SDK发现包名是xxx.framework, 类名前缀是bbbb, 无论是缩写还是正常思考方式都对不上。这个可以参考下系统如：UIKit类名前缀UI，CoreFoundation，类名前缀CF等等。建议包名大写字母开头，以驼峰命名方式。

####代码风格一定要一致

SDK接入者看不到你实现上屌炸天的代码，但是接口API暴露无遗。所以，在头文件中风格一定要统一！空格，回车，函数参数大小写等细节一定要去关注。曾经接入过一个SDK，感觉每一行代码都是不同人操刀的，让我这种代码强迫症者很崩溃（好吧，不要脸一把）。

####函数命名遵循共性，不要出现歧义或者违背大家的共识

命名这个问题，每个人都有自己的一套，个人认为只要自己保证一致，看起来也挺工整。但是一些共识大家还是需要去遵循的。比如init是用来生成对象的，不是用来设置生成好的对象属性的，这个是苹果和iOS开发一致认可的，就不要出现这种函数命名了。

####代码注释要规范和清楚

虽然SDK提供了文档，但是接入者不一定每次都仔细去看，所以接口里面的注释还是要认认真真写。对于注释的格式，以前是喵神的VVDocumenter，现在Xocde原生自带，正常用就好了。对于接口的入参，一定要说清楚，千万别出现说了一半，然后加了个链接：详细请参考XXXX。

####SDK功能正确，编译无警告和错误，支持最新的特性

发出去的SDK一定要经过完整测试，当然，这是废话！提供出去的SDK，应该做到无警告，配置好依赖的库后编译无错误。谁也不想见到接入SDK后工程一下子多了一堆警告。对于新的特性比如iOS的bitcode，iOS8之后开放的动态库，都应该积极去支持。








### 错误码/错误信息 设计

错误码设计可以简单分为三个阶段:

1. 直接透传外部SDK的错误码 : 这样有几个问题, 外部各个平台错误码可能会重复, 而且错误码层次不一致, 游戏需要理解大量的错误码.

2. 简单转换归类外部平台错误码: 将外部平台错误码做归类整合变为我们自己的错误码. 这个阶段按我们内部逻辑区分错误码(我不会告诉你们, 其实就是拍脑袋想的分类).

3. 伴随着错误码的还有错误信息, 错误信息要在前期定位好的他们的作用, 是用于开发内部定位问题OR提示用户, 如果是用于提示用户, 最好是做成可配置的, 因为可能涉及到国际化之类的问题, 另外如果是用于开发内部定位问题, 则应该注意里面应该包含足够的错误信息. 例如之前给一个同事聊天了解到他们的错误信息设计方法是, 首先错误码分段: 10000, 20000, 30000 …, 然后某个模块如果发生错误, 则将错误码返回到下游模块, 下游模块将上游的错误码加到错误信息中, 并将错误码转换成本模块错误码, 继续返回给调用者, 依次类推, 这样可以保证任何一层调用者, 只要收到了错误信息, 可以迅速看出来是哪个模块出现了问题.

######错误码: 分级, 一层简化错误码引导用户做后续流程, 一层详细错误码详细告诉用户发生了什么(不需要的用户可以完全忽略这个错误码).

######错误信息: 基于错误码分段, 可将错误码整合到错误信息中, 一次请求经过的所有模块错误码全都包含在内, 方便定位问题.



### 接口设计

###### 同步接口设计

设计一个对外接口之前肯定要考虑的几件事:

接口名称  

>我们之前将自己的接口全都带了统一的前缀, 现在想起来, 这种做饭真是傻的可爱~, 不过之前接口名称上也有做的还不错的, 我们每个接口名称都很长, 基本上说了这个接口在干什么, 这点对于SDK 接口来说真的太重要的了, 一个好得接口名称可以让你少些好几页的文档.

接口输入
> 我们之前将自己的接口全都带了统一的前缀, 现在想起来, 这种做饭真是傻的可爱~, 不过之前接口名称上也有做的还不错的, 我们每个接口名称都很长, 基本上说了这个接口在干什么, 这点对于SDK 接口来说真的太重要的了, 一个好得接口名称可以让你少些好几页的文档.

接口输出

> 最后关于输出呢, 函数的输出可以是返回值或者回调, 对于同步接口, 通常是直接将输出放入返回值中. 如果是异步接口则可能同时具有返回值和回调. 异步接口的返回值将在下面继续探讨.
> 
> 


##### 异步接口设计

在设计异步接口之前一定要想清楚确实需要异步接口吗? 因为如果你提供一个阻塞的同步接口, 使用者可以自己开一个线程自己将其变为异步接口使用, 但是如果你提供的异步接口, 使用者像将其改为同步就比较麻烦, 回调太多也会导致代码较为混乱, 所以我认为非必要不提供异步接口, 或者说为了方便, 同一个接口提供异步和同步两种.

#### 异步接口返回值设计
通常情况下异步接口的返回值会用来标识参数是否合法, 如果参数不合法直接返回false并且不会有回调. 我觉得这里最重要的一点是: 规则统一, 一定要在实现前确定规则, 例如参数错误是给错误回调 OR 直接返回false不回调, 出错如何回调, 错误码如何定义(见前面错误码部分), 成功如何回调, 并且保证如果参数正确一定要有回调(如果此调用有外部依赖最好是在SDK内部做定时器处理超时, 超时后给调用者回调), 因为很有可能调用以后不做超时处理等SDK回调, 一旦出现SDK没有回调的情况, 则将造成无限等待.


#### 异步接口回调设计

* 每个异步接口传入各自的回调对象, 以此来保证一个请求清晰对应一个回调.

* 如果还是需要使用公共回调对象, 增加字段来标识请求, 例如调用时同步返回一个请求ID, 回调时候时候将ID此ID带回来(startActivityForResult中的requestCode就是这样的). 其实通常情况如果可以把所有请求的数据带回来是更好的方式.



### 环境规划和管理

除了代码层面的一些问题, 各种环境的管理也是必不可少的, 例如我们的环境变化过程如下(下面会细说如此变化的原因):

正式环境
正式环境+联调环境
正式环境+联调环境+开发环境
正式环境+联调环境+开发环境+测试环境

开始阶段, 项目最开始只有一个环境, 后来遇到游戏自己测试数据和正式的数据会相互影响, 于是增加联调环境给游戏联调使用, 相当于游戏的测试环境.
后来, 由于SDK内部开发节奏较快, 经常更新联调环境代码, 多次出现联调环境不可用, 造成大量的联调咨询, 于是想到需要保持游戏联调环境的稳定, 新增开发环境用于内部开发使用.
再后来, 有专业测试人员接入, 为了保证联调环境的稳定, 没经过测试的版本肯定是不能放到联调/正式环境上的, 也就是说测试肯定不能到联调或者正式环境上测试, 那如果到开发环境测试同样还是会遇到问题(开发环境经常变), 这样就必须要再增加一个环境给测试使用.
最后各种环境使用的流程如下:

开发在开发环境完成开发
将开发环境版本部署到测试环境
测试在测试环境测试版本(此时开发可以在开发环境继续开发, 互不影响)
测试环境版本测试通过以后发布(当然是灰度的)到联调环境和正式环境

具体需要那些环境需要的根据各自的业务场景确定, 首先必须要确定有哪几类人会使用这些环境, 做好归类, 然后再梳理清楚他们之前是否不能相互影响, 那些是互斥的, 那些可以公用环境, 这样来最终确定需要那些环境. 在项目前期做好这些规划能省很多事, 我们在整个环境变更的过程中也吃了不少的亏.


### 版本开发/发布策略管理

关于版本管理,一定要灰度…

发布版本灰度以后, 其实吧, 就是每次先找少量游戏让我们坑一下, 坑完我们填一遍坑, 然后我们在全量, 这样发出去的版本一半不会出现很大的BUG或者说不会出现大量的BUG. 这应该算是做的比较成功的一点.


### 开发规范/流程

越早定义规范越好, 规范中不明确的点团队内及时沟通, 保持团队内对规范的理解一致. 出现问题尝试梳理规范(这里不是指那些条条框框, 规范一定要实用), 但是规范如果让人执行, 那肯定是不可能完全靠谱的, 所以.....  能用代码做的一定交给代码做, 例如SDK打包过程, 可以定义一个规范说明要放那些文件, 文件夹如何命名等等, 前期确实这样做了, 结果是基本上每次都会有一点遗漏, 后来用了一个脚本打包, 从那以后生活美好了许多. 故能用代码做的就用代码做, 代码比人更可信.





##设计篇
###一、易用性
SDK本身就是一些公用代码或者业务的整合，已经帮我们做了很多工作和隐藏了细节。如何让SDK易用，我觉得可以从以下几个点进行考虑：

#####SDK集成成本

接入SDK步骤都是添加SDK到工程，配置好依赖库和编译设置。对于一些复杂功能的SDK或者核心部分是C或者C++实现来说配置可能更多点。还好我们有cocoapods可以帮助我自动配置！如果能够支持cocoapods尽量都支持吧。

#####API调用简单

SDK好用不好用，看调用API就感受出来了。如果说接入方为了接一个功能，发现接入代码侵入了他们很多业务代码，那显然就是使用起来比较复杂的。开发最喜欢说的一句就是我都弄好了，你只要接下就好了，真的很简单！只要一行代码！理想情况下每个人喜欢这样的代码[PayManager payWithOrderId:@"xx"]

#####功能可以定制

上面刚说只要一行代码，这边就要写好几行代码了！实际上，我们接入SDK，可能因为API完成的功能不能细分，UI不符合项目风格和要求，某些业务流程所限等原因，我们需要对SDK进行定制来达到要求。所以，对于这点，在SDK开发的时候，SDK架构设计上要考虑这个需求。如果让接入者考虑奇淫巧技来实现这个目的，那就gg了！

#####便于调试

接入SDK肯定会遇到问题，因为SDK不是源码，所以接入者无法方便的进行调试。这个时候我们应该提供API，打印出SDK debug日志，给出一些提示性的信息，方便排查问题。

#####API回调参数明确

SDK调用完，我们需要处理结果。对于回调的参数类型model还是dictionary。个人还是比较偏向model，为什么呢？因为model编译的时候就可以检查而dictionary不行。并且model比dictionary更清楚，知道具体的参数。这点大家可以感受下微信支付和支付宝支付的回调参数。

#####API稳定

说实话，要做到这点还是有点难度的！SDK在开发前期，谁也不能保证未来API不会发生大的变动。特别是SDK业务初期快速迭代，可能每一版都会发生变化。但是，在SDK整体稳定后，大的功能API应该追求稳定。每次让接入者更新SDK和重新接入一个成本一样大，那估计得被吐槽死，以后都不想升级了。
###二、API设计
个人觉得这个是SDK开发最纠结和最困难的环节！虽然我们每次都进行讨论和斟酌，有时候还是跟不上需求的变动。理想中的API设计，应该有种魔力，引导接入者去接入。或者能够和接入者开发经验或者接入其他SDK的经验产生共鸣，让他接入感觉很愉快。
下面就分享几点API设计踩过的坑和经验：

#####参数命名一定要明确无歧义

参数的命名写长点，没关系！比如platformId和appPlatformId。当两个参数一起传的时候，就凌乱了。这个是我们SDK初期命名踩的最坑的一个地方！接入我们SDK很多人都不懂这两个参数有啥区别。这个设计之初是没问题的，只是后来需求变了！platfomrId真实含义是orderPlatformId！所以一个好的命名省不少事。

#####自给自足，丰衣足食

SDK经常会采集一些接入方的数据，比如bundleID，appName，appVersion等信息。如果需要的信息能够自己获取，那就请珍惜接口每一个宝贵的入参位置。

#####SDK配置参数和接口入参分开

很多SDK在使用之前，可能需要设置基本参数，比如”key“，”productId“等。基本大家都是在appDelegate中调用类似[xx registerAPP:"appid"], [xx configSDKKey:"key"]进行初始化的。那这点为什么要说下呢？在设计SDK的初期，可能由于业务接口简单，需要的参数并不多，有时候直接当入参带进接口。如果未来入参更多，或者开放的API更多，又都用到了这个参数，并且在APP生命周期里面只要设置一次，那么可以考虑将其列为配置参数。

#####SDK参数：拼接的字符串

如果入参依赖后端的配置，那么直接使用类似URL query部分格式的字符串。比如支付宝支付的orderString: orderId=123&sign=28fhfh&sign_type=RSA 这类格式。未来扩展性比较高，而且所有版本都可以支持。

#####同一类参数，封装成model，隐藏属性，通过方法构造

如果API参数过多，可以考虑将一类参数归为一类，减少入参个数，也便于以后进行扩展，保持主API稳定。对于归类好的参数，建议不要让接入者通过[[xxx alloc] init]生成对象，然后通过setter进行参数赋值。直接隐藏掉类属性，通过提供的便捷构造方法进行创建和赋值。这样做的好处是，在API参数升级的时候，如果新增的参数必传，可以在接入方升级的时候，只要需要改动参数构造的API。

#####API功能单一，减少类似enum的入参设计

一个API应该单一，入参中除特殊情况外，都不应该出现类似type,enum等入参形式。这类信息最好对接入者屏蔽。一个API承担的功能越多，未来改动的可能性越大。

#####用于查询的属性，绝对不能直接设置

SDK会提供一些方法和属性，让接入者知道SDK的当前状态。常见的比如- (BOOL)islogin;，@property(nonatomic, assign, readonly) BOOL isLogin;。方法可以隐藏属性，保证不被修改，如果是属性，一定要加readonly。

#####API 回调设计

回调设计其实没啥好说的，delegate和block比较常见。根据场景自己决定一种。




####SDK打包形式

* Static Library
* Dynamic Framework
* Universal Framework


###开发注意事项
由于SDK开发，很多东西没有开发APP那么爽，缺少了优秀的第三方，很多东西都要自己去造轮子！而且运行环境很恶劣！你不知道外面有多少黑科技在搞着你。
开发SDK的人可以注意下以下几个点：

* 能用系统的API解决的，就不要使用第三方，减少对其他库的依赖
* OC没有命名空间，类命名和类别方法加上前缀
* 黑科技虽然好，但是能不用的就不要用
* 多考虑第三方带来的影响，比如键盘处理，UIKit的UIAppearance等
* 依赖其他SDK的，别打包在一起，不然出现符号表重复
* 使用了OC类别打包的时候记得加上-ObjC
* 能不用单例的就尽量少的使用
* 核心代码的安全性
* 资源文件使用bundle进行管理，能不用xib的就别用了吧




## 开发和测试工程
SDK寄生在APP中，开发者需要搭建测试工程，去开发和模拟接入的真实情况。这边想说的就是开发一个测试工程，方便的进行测试和开发，工作量其实并不小。SDK里面能不写测试代码的都不要去写，写得越多，越容易出现发版没有关闭测试代码的情况。得益于OC是门动态语言，很多工具都可以以AOP的形式进行集成。
分享下我们SDK主要开发了哪些功能：

* 网络环境自由切换，本地MOCK和远程一键切换
* 日志系统，自由筛选不同日志
* 测试账号一键切换
* crash日志本地收集
* 第三方调试工具：FLEX
* 测试环境数据一键录入
* 单元测试BDD，UI自动化























